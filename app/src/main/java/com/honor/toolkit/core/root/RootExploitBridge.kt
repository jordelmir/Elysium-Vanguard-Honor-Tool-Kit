package com.honor.toolkit.core.root

import android.content.ComponentName
import android.content.ServiceConnection
import android.os.IBinder
import android.util.Log
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import rikka.shizuku.Shizuku

object RootExploitBridge {

    private const val TAG = "RootExploitBridge"
    private var gpuBroker: IGpuBroker? = null
    
    private val _brokerConnected = MutableStateFlow(false)
    val brokerConnected: StateFlow<Boolean> = _brokerConnected.asStateFlow()

    private val userServiceArgs = Shizuku.UserServiceArgs(
        ComponentName("com.honor.toolkit", GpuBrokerService::class.java.name)
    ).daemon(false).debuggable(true).processNameSuffix("gpu_broker")

    private val serviceConnection = object : ServiceConnection {
        override fun onServiceConnected(name: ComponentName?, service: IBinder?) {
            Log.i(TAG, "✓ Sovereign Guard Broker CONNECTED")
            gpuBroker = IGpuBroker.Stub.asInterface(service)
            _brokerConnected.value = true
        }

        override fun onServiceDisconnected(name: ComponentName?) {
            Log.w(TAG, "✗ Sovereign Guard Broker DISCONNECTED")
            gpuBroker = null
            _brokerConnected.value = false
        }
    }

    init {
        try {
            System.loadLibrary("exploit_bridge")
            Log.i(TAG, "exploit_bridge.so loaded")
        } catch (e: UnsatisfiedLinkError) {
            Log.e(TAG, "Failed to load exploit_bridge: ${e.message}")
        }
    }

    fun initBroker() {
        if (!com.honor.toolkit.core.shizuku.ShellExecutor.isShizukuAvailable()) {
            Log.e(TAG, "Shizuku not available, cannot init broker")
            return
        }
        try {
            Shizuku.bindUserService(userServiceArgs, serviceConnection)
        } catch (e: Exception) {
            Log.e(TAG, "Failed to bind user service: ${e.message}")
        }
    }

    /* Core JNI exports */
    external fun nativeGetUid(): Int
    external fun nativeTriggerExploit(payloadPath: String): Boolean

    /* Staged telemetry JNI exports */
    external fun nativeGetStage(): Int
    external fun nativeGetLog(): String
    external fun nativeGetKernelLeak(): Long

    const val STAGE_NONE = 0
    const val STAGE_DRIVER_REACHABLE = 1
    const val STAGE_VULN_TRIGGER = 2
    const val STAGE_OOB_READ = 3
    const val STAGE_OOB_WRITE = 4
    const val STAGE_CRED_MUTATION = 5
    const val STAGE_REAL_ROOT = 6
    const val STAGE_SYSTEM_ACCESS = 7

    fun getUid(): Int {
        return try {
            gpuBroker?.getBrokerUid() ?: nativeGetUid()
        } catch (e: Exception) {
            nativeGetUid()
        }
    }

    fun isRooted(): Boolean {
        return getUid() == 0
    }

    fun attemptEscalation(): Boolean {
        // Run the Exploit State Machine (ESM) inside the privileged broker!
        val broker = gpuBroker
        if (broker != null) {
            Log.i(TAG, "Executing ESM within Sovereign Guard Broker (IPC)...")
            return try {
                broker.runEsm()
            } catch (e: Exception) {
                Log.e(TAG, "Broker ESM execution failed: ${e.message}")
                false
            }
        }
        
        Log.e(TAG, "❌ FATAL: Sovereign Guard Broker (Shizuku) is OFFLINE. Cannot run exploit in untrusted_app context.")
        return false // STRICT FAILURE: Do not fall back to local unprivileged execution.
    }

    fun getStageName(stage: Int): String = when(stage) {
        STAGE_NONE -> "INITIALIZING"
        STAGE_DRIVER_REACHABLE -> "BROKER OPERATIONAL"
        STAGE_VULN_TRIGGER -> "SMMU BREACHING..."
        STAGE_OOB_READ -> "KASLR BYPASS"
        STAGE_OOB_WRITE -> "WRITE ARMED"
        STAGE_CRED_MUTATION -> "ROOT MUTATION"
        STAGE_REAL_ROOT -> "SYSTEM OWNED"
        STAGE_SYSTEM_ACCESS -> "ROOT PERSISTENCE"
        else -> "SCANNING..."
    }

    fun getExploitLog(): String {
        val brokerLog = try { gpuBroker?.getBrokerLog() ?: "" } catch (_: Exception) { "" }
        val localLog = nativeGetLog()
        return if (brokerLog.isNotEmpty()) {
            "--- SOVEREIGN GUARD LOG (UID 2000) ---\n$brokerLog"
        } else {
            "--- LOCAL LOG (UID 10374) ---\n$localLog"
        }
    }

    fun getStage(): Int {
        return try {
            gpuBroker?.getEsmStage() ?: nativeGetStage()
        } catch (e: Exception) {
            nativeGetStage()
        }
    }

    fun getKernelLeak(): Long {
        return try {
            gpuBroker?.getEsmLeak() ?: nativeGetKernelLeak()
        } catch (e: Exception) {
            nativeGetKernelLeak()
        }
    }

    fun requestSu(cmd: String): String {
        return try {
            gpuBroker?.requestSuSession(cmd) ?: "Error: Broker Offline"
        } catch (e: Exception) {
            "Error: ${e.message}"
        }
    }
}
